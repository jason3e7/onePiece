<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="css/bootstrap.min.css">

  <title>one piece</title>  
</head>

<body>
<div class="jumbotron">
  <div class="container">
    <h1 class="display-3">All in One</h1>
  </div>
</div>
<div class="container" id="files">
  <div class="input-group mb-3">
    <input class="fuzzy-search form-control"  placeholder="Search" />
  </div>
  <table class="table">
    <thead>
      <tr>
        <th scope="col" class="sort" data-sort="time">Modify Time</th>
        <th scope="col" class="sort" data-sort="rating">Rating</th>
        <th scope="col" class="sort" data-sort="ftype">File Type</th>
        <th scope="col" class="sort" data-sort="tags">Tags</th>
        <th scope="col" class="sort" data-sort="description">Description</th>
      </tr>
    </thead>
    <tbody class="list">
    </tbody>
  </table>
</div>

<script src="js/list.js"></script>
<script src="js/jquery-3.3.1.js"></script>
<script src="js/popper.min.js"></script>
<script src="js/bootstrap.min.js"></script>

<script>
var values = [];
var dirCount = 0;

function loadFile(basepath, callback) {
  var xhttp = new XMLHttpRequest();
  xhttp.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
      callback(basepath, this);
    }
  };
  xhttp.open("GET", basepath + "index.md", true);
  xhttp.send();
};

function parseMD(basepath, text, callback) {
  //console.log("parseMD");
  //console.log(basepath);
  var lines = text.split('\n');
  for(var i = 0; i < lines.length; i+=2){
    var element = new Object();
    
    element.mtime = lines[i].match(/\\#mtime:(\w*)/is)[1];
    element.rating = lines[i].match(/\\#rating:(\w*)/is)[1];
    element.ftype = lines[i].match(/\\#type:(\w*)/is)[1];
    element.tags = lines[i].match(/\\#(\w*)[,\.]/gis).join(" ").replace(/\\/g, "")
    link = lines[i].match(/\[([^\[]+)\]\(([^\)]+)\)/);
    path = basepath + link[2];
    element.description = "<a href='" + path + "'>" + link[1] + "</a>, ";
    element.description += lines[i + 1].match(/  \* (.*)/is)[1];

    if(element.ftype === "dir") {
      //console.log(path);
      dirCount = dirCount + 1;
      loadFile(path + "/", function(basepath, xhttp){
        //console.log(basepath);
        parseMD(basepath, xhttp.responseText, render);
      });
    }
    values.push(element);
  }
  callback();
}

loadFile("", function(basepath, xhttp) {
  parseMD(basepath, xhttp.responseText, render);
});


function render() {
  //console.log(dirCount);
  if(dirCount === 0) {
    var options = {
    valueNames: [ 'mtime', 'rating', 'ftype', 'tags', 'description' ],
    item: '<tr><td class="mtime"></td><td class="rating"></td><td class="ftype"></td><td class="tags"></td><td class="description"></td></tr>'
    };
    var fileList = new List('files', options, values);
  } else {
    dirCount = dirCount - 1;
  }
};

</script>

</body>
</html>
