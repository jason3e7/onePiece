<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="css/bootstrap.min.css">
  <link rel="icon" href="images/kisspng-monkey-d-luffy-vinsmoke-sanji-usopp-gol-d-roger-nice-vector-5ad8d386d404b0.3166113115241593668684.jpg">
  <title>one piece</title>  
</head>

<body>
<div class="jumbotron">
  <div class="container">
    <h1 class="display-3">All in One</h1>
  </div>
</div>
<div class="container" id="files">
  <div class="input-group mb-3">
    <input class="form-control" id="search" placeholder="Search" />
  </div>
  <div class="input-group mb-3">
    <input class="form-control" id="ratingFilter" placeholder="Rating Filter">&nbsp;
    <button class="btn btn-success" onclick="doSearch();">Apply</button>&nbsp;
    <button class="btn btn-danger" onclick="resetList();">Clear</button>
  </div>
  <div class="input-group mb-3">
    <div id="output"></div>
  </div>
  <table class="table">
    <thead>
      <tr>
        <th scope="col" class="sort" data-sort="mtime">Modify Time</th>
        <th scope="col" class="sort" data-sort="rating">Rating</th>
        <th scope="col" class="sort" data-sort="ftype">File Type</th>
        <th scope="col" class="sort" data-sort="tags">Tags</th>
        <th scope="col" class="sort" data-sort="description">Description</th>
      </tr>
    </thead>
    <tbody class="list">
    </tbody>
  </table>
</div>

<script src="js/list.js"></script>
<script src="js/jquery-3.3.1.js"></script>
<script src="js/popper.min.js"></script>
<script src="js/bootstrap.min.js"></script>

<script>
var values = [];
var dirCount = 0;

function loadFile(basepath, callback) {
  var xhttp = new XMLHttpRequest();
  xhttp.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
      callback(basepath, this);
    }
  };
  xhttp.open("GET", basepath + "index.md", true);
  xhttp.send();
};

function parseMD(basepath, text, callback) {
  var lines = text.split('\n');
  for(var i = 0; i < lines.length; i+=3){
    if(lines[i].trim() === "") {
      continue;
    }
    
    try {
      var element = new Object();
      
      element.mtime = lines[i].match(/\\#mtime:(\w*)/is)[1];
      element.rating = lines[i].match(/\\#rating:(\w*)/is)[1];
      element.ftype = lines[i].match(/\\#type:(\w*)/is)[1];
      element.tags = lines[i + 1].match(/\\#(\w*)[,\.]/gis).join(" ").replace(/\\/g, "")
      link = lines[i].match(/\[(.+)\]\(([^\)]+)\)/);
      path = basepath + link[2];
      if (/^(http|https)?:\/\//i.test(link[2])) {
        path = link[2];
      }
      if(element.ftype === "md") {
        element.description = "<a href='remarkable.html?src=" + path + "'>" + link[1] + "</a>, ";
      } else {
        element.description = "<a href='" + path + "'>" + link[1] + "</a>, ";
      }
      element.description += lines[i + 2].match(/  \* (.*)/is)[1];

      if(element.ftype === "dir") {
        dirCount = dirCount + 1;
        loadFile(path + "/", function(basepath, xhttp){
          parseMD(basepath, xhttp.responseText, render);
        });
      }
      values.push(element);
    } catch(e) {
      console.log(basepath)
      console.log(e.message)
    }
  }
  callback();
}

loadFile("", function(basepath, xhttp) {
  parseMD(basepath, xhttp.responseText, render);
});

var fileList;
var options = {
  valueNames: [ 'mtime', 'rating', 'ftype', 'tags', 'description' ],
  item: '<tr><td class="mtime"></td><td class="rating"></td><td class="ftype"></td><td class="tags"></td><td class="description"></td></tr>',
  fuzzySearch: {
    searchClass: "fuzzy-search",
    location: 0,
    distance: 1000,
    threshold: 0.4,
    multiSearch: true
  }
};

function render() {
  if(dirCount === 0) {
  
    fileList = new List('files', options, values);

    fileList.filter(function(item) {
      if (item.values().ftype == "dir") {
        return false;
      }
      return true;
    });
    baseSort();

    showCount();
    
  } else {
    dirCount = dirCount - 1;
  }
};

function resetList(){
  fileList.search();
  fileList.filter();
  fileList.update();
  showCount();
};

document.getElementById('ratingFilter').addEventListener('change', updateList);

function updateList() {
  var target = this.value;
  fileList.filter(function(item) {
    if (item.values().rating > target) {
      return false;
    }
      return true;
  });
  baseSort();
}

function baseSort() {
  fileList.sort('rating', { order: "asc" });
  fileList.sort('mtime', { order: "desc" });
}

function doSearch() {
  var target = document.getElementById("search").value;
  var keywords = target.split(" ");
  fileList.filter(function(item) {
    var info = item.values();
    var flag = 0;
    kLen = keywords.length;
    for (i = 0; i < kLen; i++) {
      keyword = keywords[i];
      flag = 0;
      for (k in info) {
        if (info[k].search(keyword) != -1) {
          flag = 1;
        }
      } 
      if (flag == 0) {
        return false;
      }  
    }
    return true;
  });
  showCount();
}

var input = document.getElementById("search");

input.addEventListener("keyup", function(event) {
  event.preventDefault();
  if (event.keyCode === 13) {
    doSearch();
    this.blur();
  }
});

function showCount() {
  var output = "About " + fileList.update().matchingItems.length + " results"; 
  document.getElementById("output").innerText = output;
}

</script>

</body>
</html>
