<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

  <link rel="stylesheet" href="css/bootstrap.min.css">
  <link rel="icon" href="images/kisspng-monkey-d-luffy-vinsmoke-sanji-usopp-gol-d-roger-nice-vector-5ad8d386d404b0.3166113115241593668684.jpg">
  <title>one piece</title>  
  <style type="text/css">
  .btn-label {
    margin-top: 4px;
    margin-left: 4px;
  }
  </style>
</head>

<body>
<div class="jumbotron">
  <div class="container">
    <h1 class="display-5">All in One</h1>
  </div>
</div>
<div class="container" id="files">
  <div class="input-group mb-3">
    <input class="form-control" id="search" placeholder="keyword -filter column:value column>value column<value" autofocus="autofocus"/>&nbsp;
    <button class="btn btn-success" onclick="doSearch();">Search</button>&nbsp;
    <button class="btn btn-primary" data-toggle="collapse" data-target=".bar">Tools</button>
  </div>  
  <div class="mb-3">
    <div class="collapse bar">
      <nav class="navbar bg-light">
        <div>
          <select id="showTags">
            <option value="0" selected>tags:hide</option>
            <option value="1">tags:show</option>
          </select>
          <!-- design first -->
          <select id="mode">
            <option value="0" selected>mode:default</option>
            <option value="1">mode:all</option>
          </select>
        </div>
      </nav>
    </div>
    <div id="output" class="collapse bar show"></div>
    <div id="tags" style="display:none"></div>
  </div>
  <table class="table table-sm table-hover">
    <thead>
      <tr>
        <th scope="col" class="sort" data-sort="mtime">Modify Time</th>
        <th scope="col" class="sort" data-sort="rating">Rating</th>
        <th scope="col" class="sort" data-sort="ftype">File Type</th>
        <th scope="col" class="sort" data-sort="tags">Tags</th>
        <th scope="col" class="sort" data-sort="description">Description</th>
      </tr>
    </thead>
    <tbody class="list">
    </tbody>
  </table>
</div>

<script src="js/list.js"></script>
<script src="js/jquery-3.3.1.js"></script>
<script src="js/popper.min.js"></script>
<script src="js/bootstrap.min.js"></script>

<script>
function setCookie(name,value,days) {
    var expires = "";
    if (days) {
        var date = new Date();
        date.setTime(date.getTime() + (days*24*60*60*1000));
        expires = "; expires=" + date.toUTCString();
    }
    document.cookie = name + "=" + (value || "")  + expires + "; path=/";
}
function getCookie(name) {
    var nameEQ = name + "=";
    var ca = document.cookie.split(';');
    for(var i=0;i < ca.length;i++) {
        var c = ca[i];
        while (c.charAt(0)==' ') c = c.substring(1,c.length);
        if (c.indexOf(nameEQ) == 0) return c.substring(nameEQ.length,c.length);
    }
    return null;
}

function GetURLParameter(sParam) {
  var sPageURL = window.location.search.substring(1),
    sURLVariables = sPageURL.split('&'),
    sParameterName,
    i;

  for (i = 0; i < sURLVariables.length; i++) {
    sParameterName = sURLVariables[i].split('=');

    if (sParameterName[0] === sParam) {
      return sParameterName[1] === undefined ? true : decodeURIComponent(sParameterName[1]);
    }
  }
}

var values = [];
var dirCount = 0;
var tags = {};
var now = (new Date()).toISOString().slice(0,10).replace(/-/g,"");

function loadFile(basepath, callback) {
  var xhttp = new XMLHttpRequest();
  xhttp.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
      callback(basepath, this);
    }
  };
  xhttp.open("GET", basepath + "index.md", true);
  xhttp.send();
};

function loadImd(filepath, callback) {
  var xhttp = new XMLHttpRequest();
  xhttp.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
      callback(filepath, this);
    }
  };
  xhttp.open("GET", filepath, true);
  xhttp.send();
};


function parseMD(basepath, text, callback) {
  var lines = text.split('\n');
  for(var i = 0; i < lines.length; i++){
    if(lines[i].trim() === "" || lines[i][0] !== '*') {
      continue;
    }

    try {
      var element = new Object();
      
      element.mtime = lines[i].match(/\\#mtime:(\w*)/is)[1];
      element.rating = lines[i].match(/\\#rating:(\w*)/is)[1];
      element.ftype = lines[i].match(/\\#type:(\w*)/is)[1];
      element.tags = lines[i + 1].match(/\\#(\w*)[,\.]/gis).join(" ").replace(/\\/g, "")
      link = lines[i].match(/\[(.+)\]\(([^\)]+)\)/);

      if(element.ftype === "imd" && link[2] != "index.md") {
        basepath = basepath.substring(0,basepath.lastIndexOf("/") + 1);
      }

      path = basepath + link[2];
      if (/^(http|https)?:\/\//i.test(link[2])) {
        path = link[2];
      }

      if(element.ftype === "md" || element.ftype === "imd") {
        element.description = "<a href='remarkable.html?src=" + path + "'>" + link[1] + "</a>, ";
      } else {
        element.description = "<a href='" + path + "'>" + link[1] + "</a>, ";
      }
      
      if(element.ftype !== "dir") {
        line2 = lines[i + 2].match(/  \* (.*)/is)[1];
        match = line2.match(/\\#to:(.*), |\\#to:(.*)./is);
        if (match[2] == undefined) {
          element.description += match[1];
        }
        if (match[1] == undefined) {
          element.description += match[2];
        }
      }

      if(element.ftype === "dir") {
        dirCount = dirCount + 1;
        loadFile(path + "/", function(basepath, xhttp){
          parseMD(basepath, xhttp.responseText, render);
        });
      }

      if(element.ftype === "imd" && link[2] != "index.md") {
        dirCount = dirCount + 1;
        loadImd(path, function(basepath, xhttp){
          parseMD(basepath, xhttp.responseText, render);
        });
      }

      values.push(element);
    } catch(e) {
      console.log(basepath)
      console.log(e.message)
    }
  }
  callback();
}

loadFile("", function(basepath, xhttp) {
  parseMD(basepath, xhttp.responseText, render);
});

var fileList;
var options = {
  valueNames: [ 'mtime', 'rating', 'ftype', 'tags', 'description' ],
  item: '<tr><td class="mtime"></td><td class="rating"></td><td class="ftype"></td><td class="tags"></td><td class="description"></td></tr>',
  fuzzySearch: {
    searchClass: "fuzzy-search",
    location: 0,
    distance: 1000,
    threshold: 0.4,
    multiSearch: true
  }
};

function render() {
  if(dirCount === 0) {
  
    fileList = new List('files', options, values);
    baseSort();

    q = GetURLParameter("q");
    if (q === undefined) {
      q = ""
    }
    document.getElementById("search").value = q;
    doSearch();

  } else {
    dirCount = dirCount - 1;
  }
};

function resetList(){
  fileList.search();
  fileList.filter();
  fileList.update();
  showCount();
};

function baseSort() {
  fileList.sort('rating', { order: "asc" });
  fileList.sort('mtime', { order: "desc" });
}

function doSearch() {
  var target = document.getElementById("search").value;
  var conditions = target.split(" ");
  var keywords = Array();
  var filters = Array();
  var operators = new Object();
  var GTs = new Object();
  var LTs = new Object();
  
  if (GetURLParameter("q") !== target) {
    window.history.pushState(null, null, "?q=" + target.replace(/#/g, "%23"));
  }
  
  if($("#mode").val() === "0") {
    console.log("mode:default");
    conditions.push("-dir");
    conditions.push("-imd");
    conditions.push("mtime:" + now);
  }

  cLen = conditions.length;
  for (i = 0; i < cLen; i++) {
    var locate = conditions[i].search(':');
    var GT_locate = conditions[i].search('>');
    var LT_locate = conditions[i].search('<');
    if(locate != -1) {
      operators[conditions[i].substring(0, locate)] = conditions[i].substring(locate + 1);
    } else if(GT_locate != -1) {
      GTs[conditions[i].substring(0, GT_locate)] = conditions[i].substring(GT_locate + 1);
    } else if(LT_locate != -1) {
      LTs[conditions[i].substring(0, LT_locate)] = conditions[i].substring(LT_locate + 1);
    } else if(conditions[i][0] == '-') {
      filters.push(conditions[i].substring(1));
    } else {
      keywords.push(conditions[i]);
    }
  }

  fileList.filter(function(item) {
    var info = item.values();
    var flag = 0;

    for (k in operators) {
      if (info.hasOwnProperty(k) === false || info[k] !== operators[k]) {
        return false;
      }
    }

    for (k in GTs) {
      if (info.hasOwnProperty(k) === false || info[k] <= GTs[k]) {
        return false;
      }
    }

    for (k in LTs) {
      if (info.hasOwnProperty(k) === false || info[k] >= LTs[k]) {
        return false;
      }
    }

    fLen = filters.length;
    for (i = 0; i < fLen; i++) {
      filter = filters[i];
      for (k in info) {
        if (info[k].search(filter) != -1) {
          return false;
        }
      }  
    }

    kLen = keywords.length;
    for (i = 0; i < kLen; i++) {
      keyword = keywords[i];
      flag = 0;
      for (k in info) {
        if (info[k].search(keyword) != -1) {
          flag = 1;
        }
      } 
      if (flag == 0) {
        return false;
      }  
    }

    return true;
  });
  showCount();
  showTags();
}

var input = document.getElementById("search");

input.addEventListener("keyup", function(event) {
  event.preventDefault();
  if (event.keyCode === 13) {
    doSearch();
    this.blur();
  }
});

function showCount() {
  var output = "About " + fileList.update().matchingItems.length + " results"; 
  document.getElementById("output").innerHTML = output;
}

function showTags() {
  tags = {};
  items = fileList.matchingItems;
  for(i = 0; i < items.length; i++) {
    item = items[i];
    tagLine = item._values.tags;
    tagLine = tagLine.split(" ");
    for (j = 0; j < tagLine.length; j++) {
      tag = tagLine[j].slice(0, -1);
      if (tags.hasOwnProperty(tag)) {
        tags[tag] += 1;
      } else {
        tags[tag] = 1;
      }
    }  
  }
  var buttonB = '<button type="button" class="btn btn-secondary btn-sm btn-label tag" data-name="';
  var buttonM = '">';
  var buttonE = '</button>';
  var spanB = ' <span class="badge badge-warning">';
  var spanE = '</span>';
  var output = '';
  for (i = 0; i < 15; i++) {
    var maxCount = 0;
    var maxTag = 0; 
    for(tag in tags) {
      if (tags[tag] > maxCount) {
        maxTag = tag;
        maxCount = tags[tag];
      }
    }
    output += buttonB + maxTag + buttonM + maxTag + spanB + maxCount + spanE + buttonE;
    delete tags[maxTag];
    if(Object.keys(tags).length === 0) {
      break;
    }
  }
  if(Object.keys(tags).length !== 0) {
    output += '<button type="button" class="btn btn-secondary btn-sm btn-label" disabled>...etc</button>';
  }

  document.getElementById("tags").innerHTML = output;
}

$("body").on('click', ".tag",function(){
    var search = document.getElementById("search").value;
    if (search !== "") {
      search = search + " " + $(this).data('name');
    } else {
      search = $(this).data('name');
    }
    document.getElementById("search").value = search;
    doSearch();
});

$("#showTags").change(function() {
  var tagsStatus = $(this).children("option:selected").val();
  if (tagsStatus == "1") {
    $("#tags").show();
    setCookie("showTags", "1", 3);
  }
  if (tagsStatus == "0") {
    $("#tags").hide();
    setCookie("showTags", "0", 3);
  }
});

if (getCookie("showTags") == null) {
  setCookie("showTags", "0", 3);
} else {
  $("#showTags").val(getCookie("showTags"));
  $("#showTags").trigger("change");
}

$("#mode").change(function() {
  var status = $(this).children("option:selected").val();
  setCookie("mode", status, 3);
  doSearch();
});

if (getCookie("mode") == null) {
  setCookie("mode", "0", 3);
} else {
  $("#mode").val(getCookie("mode"));
  $("#mode").trigger("mode");
}

</script>

</body>
</html>
